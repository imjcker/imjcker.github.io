<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {%- seo -%}

    {%- feed_meta -%}

    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="{{"/assets/css/imjcker.css" | relative_url}}">

    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/css/bootstrap.min.css">

    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script src="https://cdn.staticfile.org/popper.js/1.15.0/umd/popper.min.js"></script>
     
    <script src="https://cdn.staticfile.org/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>

    <title>{{site.title}}</title>
</head>
{%- assign default_paths = site.pages | map: "path" -%}
{%- assign page_paths = site.header_pages | default: default_paths -%}

<body class="container-fluid">
{{ content }}
</body>

<footer id="footer" class="footer" style="height: 36px;">
    <div>
        <hr>
        <div class="tooter-social" STYLE="text-align: center">
            <small><a class="social rss" target="blank" href="/feed">RSS</a>&nbsp;&nbsp;&nbsp;</small>
            <small><a class="social zhihu" target="blank" href="https://www.zhihu.com/people/ZHIHU">知乎</a>&nbsp;&nbsp;</small>
            {%- if site.social.github_username -%}
            <small><a class="social github" target="blank" href="https://github.com/{{site.social.github_username}}">Github</a>&nbsp;&nbsp;</small>
            {%- endif -%}
            {%- if site.social.twitter_username -%}
            <small><a class="social twitter" target="blank" href="https://twitter.com/{{site.social.twitter_username}}">Twitter</a>&nbsp;&nbsp;</small>
            {%- endif -%}
            <small><a class="social csdn" target="blank" href="http://blog.csdn.net/u012137018">CSDN</a>&nbsp;&nbsp;</small>
            {%- if site.social.qq -%}
            <small><a class="u-email" target="_blank" href="mailto:{{ site.social.email }}">QQ</a>&nbsp;&nbsp;</small>
            {%- endif -%}
            {%- if site.social.wechat -%}
            <small><a class="u-email" href="mailto:{{ site.social.email }}">WeChat</a>&nbsp;&nbsp;</small>
            {%- endif -%}
        </div>
    </div>
</footer>

<script src="/assets/echarts/echarts.min.js"></script>
<script>
    $(function(){
        initGraph();
    });

    function getCategories(){
        return [
            {"name": "分类"},
            {"name": "标签"},
            {"name": "文章"}
        ];
    }
    function getNodes(){
        let nodes_post = [
            {%- for post in site.posts -%}
                {
                    "id": "{{post.url}}",
                    "name": "{{post.title}}",
                    "value": "文章",
                    "category": "文章",
                    "label": {"show": true},
                    "symbolSize": 10,
                    "symbol": 'circle',
                    "x": {{site.style.css.symbolSize | sample | times: 7.3}},
                    "y": {{site.style.css.symbolSize | sample | times: 3.7}}
                },
            {%- endfor -%}
        ]

        let nodes_tag = [
            {%- for tag in site.tags -%}
                    {
                        "id": "{{tag[0]}}",
                        "name": "{{tag[0]}}",
                        "value": "标签",
                        "category": "标签",
                        "label": {"show": false},
                        "symbolSize": 20,
                        "symbol": 'image://assets/icon/{{tag[0]}}.png',
                        "x": {{site.style.css.symbolSize | sample | times: 7.3}},
                        "y": {{site.style.css.symbolSize | sample | times: 3.7}}
                    },
            {%- endfor -%}
        ]

        let nodes_cat = [
            {%- for cat in site.categories -%}
                    {
                        "id": "{{cat[0]}}",
                        "name": "{{cat[0]}}",
                        "value": "分类",
                        "category": "分类",
                        "label": {"show": false},
                        "symbolSize": 30,
                        "symbol": 'image://assets/icon/{{cat[0]}}.png',
                        "x": {{site.style.css.symbolSize | sample | times: 7.3}},
                        "y": {{site.style.css.symbolSize | sample | times: 3.7}}
                    },
            {%- endfor -%}
        ]

        // imjcker 跟节点
        let root_node = [
            {
                "id": "imjcker",
                "name": "imjcker",
                "value": "category",
                "category": "分类",
                "label": {"show": false},
                "symbolSize": 50,
                "symbol": 'image://assets/avatar.jpg',
                "x": {{site.style.css.symbolSize | sample | times: 7.3}},
                "y": {{site.style.css.symbolSize | sample | times: 3.7}}
            }
        ]

        let nodes = Array.from(new Set(nodes_cat.concat(nodes_tag).concat(nodes_post).concat(root_node)));
        return nodes;
    }
    function getLinks(){
        let links_c_root = [
            {%- for category in site.categories -%}
                {
                    "source": "{{category[0]}}",
                    "target": "imjcker"
                },
            {%- endfor -%}
        ]
        let links_t_p = [
            {%- for tag in site.tags -%}
                {%- for post in tag[1] -%}
                    {
                        "source": "{{post.url}}",
                        "target": "{{tag[0]}}"
                    },
                {%- endfor -%}
            {%- endfor -%}
        ]
        let links_c_t = [
                {%- for post in site.posts -%}
                    {%- for tag in post.tags -%}
                    {
                        "source": "{{tag}}",
                        "target": "{{post.categories[0]}}"
                    },
                    {%- endfor -%}
                {%- endfor -%}
        ]

        return links_t_p.concat(links_c_t).concat(links_c_root);
    }
    function getGraph() {
        let categories = getCategories();
        let links = getLinks();
        let nodes = uniqueBy(getNodes(), "id");
        return {
            "categories": categories,
            "links": links,
            "nodes": nodes
        }
    }

    function initGraph() {
        let chartDom = document.getElementById('main');
        let myChart = echarts.init(chartDom);
        let graph = getGraph();

        myChart.showLoading();
        myChart.hideLoading();
        graph.nodes.forEach(function (node) {
            node.label = {
                show: node.symbolSize > 1
            };
        });
        let option = {
            title: {
                text: '知识图谱',
                subtext: 'BY {{site.author}}\n{{site.posts[0].date | date: "%D" }}',
            },
            tooltip: {"show": false},
            legend: [{
                data: graph.categories.map(function (c) {
                    return c.name;
                })
            }],
            animationDuration: 1500,
            animationEasingUpdate: 'quinticInOut',
            series: [
                {
                    name: '知识图谱',
                    type: 'graph',
                    layout: 'force',
                    force: {
                        repulsion: 1,
                        edgeLength: 3
                    },
                    data: graph.nodes,
                    links: graph.links,
                    categories: graph.categories,
                    roam: true, // 缩放
                    label: {
                        position: 'right',
                        formatter: '{b}'
                    },
                    lineStyle: {
                        color: 'source',
                        curveness: 0.01
                    },
                    emphasis: {
                        focus: 'adjacency',
                        lineStyle: {
                            width: 3
                        }
                    }
                }
            ]
        };
        myChart.setOption(option);

    }

function uniqueBy(dataSet, field) {
    let dest = [];
    for (let i = 0; i < dataSet.length; i++) {
        let ai = dataSet[i];
        if (i === 0) {
            dest.push(ai);
        } else {
            let filterData = dest.filter(function (e) {
                return e[field] === ai[field];
            })
            if (filterData.length === 0) {
                dest.push(ai);
            }
        }
    }
    return dest;
}

</script>
</html>
